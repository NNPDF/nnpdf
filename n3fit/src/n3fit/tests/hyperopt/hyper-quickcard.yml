#
# Configuration file for n3fit hyperopt tests
#

############################################################
description: n3fit hyperopt test

############################################################
# frac: training fraction
# ewk: apply ewk k-factors
# sys: systematics treatment (see systypes)
dataset_inputs:
- { dataset: NMC, frac: 0.5 }
- { dataset: SLACP, frac: 0.5}
- { dataset: CMSZDIFF12, frac: 0.5, cfac: ['QCD'], sys: 10 }


############################################################
datacuts:
  t0pdfset: NNPDF31_nnlo_as_0118    # PDF set to generate t0 covmat
  q2min: 3.49                        # Q2 minimum
  w2min: 12.5                        # W2 minimum
  combocuts: NNPDF31                 # NNPDF3.0 final kin. cuts
  jetptcut_tev: 0                    # jet pt cut for tevatron
  jetptcut_lhc: 0                    # jet pt cut for lhc
  wptcut_lhc: 30.0                   # Minimum pT for W pT diff distributions
  jetycut_tev: 1e30                  # jet rap. cut for tevatron
  jetycut_lhc: 1e30                  # jet rap. cut for lhc
  dymasscut_min: 0                   # dy inv.mass. min cut
  dymasscut_max: 1e30                # dy inv.mass. max cut
  jetcfactcut: 1e30                  # jet cfact. cut

############################################################
theory:
  theoryid: 399     # database id

hyperscan_config:
  architecture:
      n_layers: [2]
      min_units: 10
      max_units: 45
  optimizer:
  - optimizer_name: 'Nadam'
    learning_rate:
      sampling: log
      min: 1e-4
      max: 1e-2
    clipnorm:
      sampling: log
      min: 1e-7
      max: 1e-4
  - optimizer_name: 'Adam'
    learning_rate:
      sampling: log
      min: 1e-4
      max: 1e-2
    clipnorm:
      sampling: log
      min: 1e-7
      max: 1e-4

kfold:
    target: average
    penalties:
      - saturation
      - patience
      - integrability
    threshold: 500.0
    partitions:
        - datasets:
            - NMC
        - datasets:
            - SLACP
            - CMSZDIFF12

############################################################
trvlseed: 2182363835
nnseed: 4044040809
mcseed: 1977428487
genrep: false      # true = generate MC replicas, false = use real data

# The baseline parameters, best ones as taken from table 3.3 in the 2021 paper
# or equivalently the NNPDF40_nnlo_as_01180_1000 runcard
# These are used for parameters that are not hyperoptimized over
parameters: # This defines the parameter dictionary that is passed to the Model Trainer
  nodes_per_layer: [25, 20, 8]
  activation_per_layer: [tanh, tanh, linear]
  initializer: glorot_normal
  optimizer:
    clipnorm: 6.073e-6
    learning_rate: 2.621e-3
    optimizer_name: Nadam
  epochs: 10
  positivity:
    initial: 184.8
    multiplier:
  integrability:
    initial: 10
    multiplier:
  stopping_patience: 0.1
  layer_type: dense
  dropout: 0.0
  threshold_chi2: 3.5

fitting:
  savepseudodata: false
  # NN23(QED) = sng=0,g=1,v=2,t3=3,ds=4,sp=5,sm=6,(pht=7)
  # EVOL(QED) = sng=0,g=1,v=2,v3=3,v8=4,t3=5,t8=6,(pht=7)
  # EVOLS(QED)= sng=0,g=1,v=2,v8=4,t3=4,t8=5,ds=6,(pht=7)
  # FLVR(QED) = g=0, u=1, ubar=2, d=3, dbar=4, s=5, sbar=6, (pht=7)
  fitbasis: EVOL  # EVOL (7), EVOLQED (8), etc.
  basis:
  - {fl: sng, trainable: false, smallx: [1.086, 1.121], largex: [1.459, 3.165]}
  - {fl: g,   trainable: false, smallx: [0.7832, 1.059], largex: [2.734, 8.173]}
  - {fl: v,   trainable: false, smallx: [0.5596, 0.7524], largex: [1.534, 3.82]}
  - {fl: v3,  trainable: false, smallx: [-0.0291, 0.5957], largex: [1.708, 3.706]}
  - {fl: v8,  trainable: false, smallx: [0.6072, 0.819], largex: [1.519, 3.691]}
  - {fl: t3,  trainable: false, smallx: [-0.4322, 1.087], largex: [1.718, 3.742]}
  - {fl: t8,  trainable: false, smallx: [0.6132, 0.958], largex: [1.531, 3.506]}
  - {fl: t15, trainable: false, smallx: [1.057, 1.142], largex: [1.469, 3.23]}

############################################################
positivity:
  posdatasets:
    - { dataset: POSF2U,   maxlambda: 1e6 }  # Positivity Lagrange Multiplier
    - { dataset: POSDYS    , maxlambda: 1e5 }

integrability:
  integdatasets:
    - {dataset: INTEGXT8, maxlambda: 1e2}

############################################################
debug: true
maxcores: 28
parallel_models: true
same_trvl_per_replica: true
